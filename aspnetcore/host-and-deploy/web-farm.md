---
title: Web ファームでの ASP.NET Core のホスト
author: rick-anderson
description: Web ファーム環境での共有リソースを使用して、ASP.NET Core アプリのインスタンスを複数ホストする方法について説明します。
monikerRange: '>= aspnetcore-2.1'
ms.author: riande
ms.custom: mvc
ms.date: 01/13/2020
no-loc:
- appsettings.json
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: host-and-deploy/web-farm
ms.openlocfilehash: ee78e80a4eda3089943765700aa6bb62c6c1e07d
ms.sourcegitcommit: 3593c4efa707edeaaceffbfa544f99f41fc62535
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/04/2021
ms.locfileid: "93057519"
---
# <a name="host-aspnet-core-in-a-web-farm"></a><span data-ttu-id="edb26-103">Web ファームでの ASP.NET Core のホスト</span><span class="sxs-lookup"><span data-stu-id="edb26-103">Host ASP.NET Core in a web farm</span></span>

<span data-ttu-id="edb26-104">作成者: [Chris Ross](https://github.com/Tratcher)</span><span class="sxs-lookup"><span data-stu-id="edb26-104">By [Chris Ross](https://github.com/Tratcher)</span></span>

<span data-ttu-id="edb26-105">"*Web ファーム*" とは、アプリのインスタンスを複数ホストする、2 つ以上の Web サーバー (または "*ノード*") のグループのことです。</span><span class="sxs-lookup"><span data-stu-id="edb26-105">A *web farm* is a group of two or more web servers (or *nodes*) that host multiple instances of an app.</span></span> <span data-ttu-id="edb26-106">ユーザーからの要求が Web ファームに到着すると、"*ロード バランサー*" が要求を Web ファームのノードに分散します。</span><span class="sxs-lookup"><span data-stu-id="edb26-106">When requests from users arrive to a web farm, a *load balancer* distributes the requests to the web farm's nodes.</span></span> <span data-ttu-id="edb26-107">Web ファームの利点は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="edb26-107">Web farms improve:</span></span>

* <span data-ttu-id="edb26-108">**信頼性/可用性**:1 つまたは複数のノードに障害が発生した場合、ロード バランサーによって要求が機能しているノードにルーティングされ、要求の処理を続行することができます。</span><span class="sxs-lookup"><span data-stu-id="edb26-108">**Reliability/availability**: When one or more nodes fail, the load balancer can route requests to other functioning nodes to continue processing requests.</span></span>
* <span data-ttu-id="edb26-109">**容量/パフォーマンス**:複数のノードは 1 台のサーバーよりもより多くの要求を処理できます。</span><span class="sxs-lookup"><span data-stu-id="edb26-109">**Capacity/performance**: Multiple nodes can process more requests than a single server.</span></span> <span data-ttu-id="edb26-110">ロード バランサーは、ノードへの要求を分散することにでワークロードのバランスをとります。</span><span class="sxs-lookup"><span data-stu-id="edb26-110">The load balancer balances the workload by distributing requests to the nodes.</span></span>
* <span data-ttu-id="edb26-111">**スケーラビリティ**:より多くの (またはより少ない) 容量が必要になると、ワークロードに一致するようにアクティブなノードの数を増加 (または減少) させることができます。</span><span class="sxs-lookup"><span data-stu-id="edb26-111">**Scalability**: When more or less capacity is required, the number of active nodes can be increased or decreased to match the workload.</span></span> <span data-ttu-id="edb26-112">[Azure App Service](https://azure.microsoft.com/services/app-service/) などの Web ファーム プラットフォーム テクノロジでは、システム管理者の要求に応じて、または人の介入なしに、自動的にノードを追加したり削除したりできます。</span><span class="sxs-lookup"><span data-stu-id="edb26-112">Web farm platform technologies, such as [Azure App Service](https://azure.microsoft.com/services/app-service/), can automatically add or remove nodes at the request of the system administrator or automatically without human intervention.</span></span>
* <span data-ttu-id="edb26-113">**保守容易性**:Web ファームのノードでは一連の共有サービスを利用できるため、システム管理が簡単になります。</span><span class="sxs-lookup"><span data-stu-id="edb26-113">**Maintainability**: Nodes of a web farm can rely on a set of shared services, which results in easier system management.</span></span> <span data-ttu-id="edb26-114">たとえば、Web ファームのノードにおいて、画像やダウンロード可能ファイルなどの静的リソースのために、単一のデータベース サーバーと共通のネットワークの場所を利用することができます。</span><span class="sxs-lookup"><span data-stu-id="edb26-114">For example, the nodes of a web farm can rely upon a single database server and a common network location for static resources, such as images and downloadable files.</span></span>

<span data-ttu-id="edb26-115">このトピックでは、共有リソースを利用する Web ファームでホストされている ASP.NET Core アプリ用の構成と依存関係について説明します。</span><span class="sxs-lookup"><span data-stu-id="edb26-115">This topic describes configuration and dependencies for ASP.NET core apps hosted in a web farm that rely upon shared resources.</span></span>

## <a name="general-configuration"></a><span data-ttu-id="edb26-116">全般構成</span><span class="sxs-lookup"><span data-stu-id="edb26-116">General configuration</span></span>

<xref:host-and-deploy/index>  
<span data-ttu-id="edb26-117">ホスティング環境を設定し、ASP.NET Core アプリを展開する方法を学習します。</span><span class="sxs-lookup"><span data-stu-id="edb26-117">Learn how to set up hosting environments and deploy ASP.NET Core apps.</span></span> <span data-ttu-id="edb26-118">Web ファームの各ノード上のプロセス マネージャーを構成して、アプリの起動と再起動を自動化します。</span><span class="sxs-lookup"><span data-stu-id="edb26-118">Configure a process manager on each node of the web farm to automate app starts and restarts.</span></span> <span data-ttu-id="edb26-119">各ノードには ASP.NET Core ランタイムが必要です。</span><span class="sxs-lookup"><span data-stu-id="edb26-119">Each node requires the ASP.NET Core runtime.</span></span> <span data-ttu-id="edb26-120">詳細については、ドキュメントの[ホストと展開](xref:host-and-deploy/index)に関する部分のトピックをご覧ください。</span><span class="sxs-lookup"><span data-stu-id="edb26-120">For more information, see the topics in the [Host and deploy](xref:host-and-deploy/index) area of the documentation.</span></span>

<xref:host-and-deploy/proxy-load-balancer>  
<span data-ttu-id="edb26-121">プロキシ サーバーとロード バランサーの背後にホストされているアプリの構成について説明します。このような構成では、要求の重要な情報がわからなくなることがよくあります。</span><span class="sxs-lookup"><span data-stu-id="edb26-121">Learn about configuration for apps hosted behind proxy servers and load balancers, which often obscure important request information.</span></span>

<xref:host-and-deploy/azure-apps/index>  
<span data-ttu-id="edb26-122">[Azure App Service](https://azure.microsoft.com/services/app-service/) は ASP.NET Core を含む Web アプリをホストするための [Microsoft クラウド コンピューティング プラットフォーム サービス](https://azure.microsoft.com/)です。</span><span class="sxs-lookup"><span data-stu-id="edb26-122">[Azure App Service](https://azure.microsoft.com/services/app-service/) is a [Microsoft cloud computing platform service](https://azure.microsoft.com/) for hosting web apps, including ASP.NET Core.</span></span> <span data-ttu-id="edb26-123">App Service は、自動スケーリング、負荷分散、修正プログラムの適用、および継続的配置を提供する、フル マネージドのプラットフォームです。</span><span class="sxs-lookup"><span data-stu-id="edb26-123">App Service is a fully managed platform that provides automatic scaling, load balancing, patching, and continuous deployment.</span></span>

## <a name="app-data"></a><span data-ttu-id="edb26-124">アプリのデータ</span><span class="sxs-lookup"><span data-stu-id="edb26-124">App data</span></span>

<span data-ttu-id="edb26-125">アプリが複数のインスタンスに対してスケーリングされると、ノード間での共有を必要とするアプリの状態が出現する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="edb26-125">When an app is scaled to multiple instances, there might be app state that requires sharing across nodes.</span></span> <span data-ttu-id="edb26-126">この状態が一時的である場合は、[IDistributedCache](/dotnet/api/microsoft.extensions.caching.distributed.idistributedcache) を共有することを検討してください。</span><span class="sxs-lookup"><span data-stu-id="edb26-126">If the state is transient, consider sharing an [IDistributedCache](/dotnet/api/microsoft.extensions.caching.distributed.idistributedcache).</span></span> <span data-ttu-id="edb26-127">共有状態を永続的に保つ必要がある場合は、共有状態をデータベースに格納することを検討してください。</span><span class="sxs-lookup"><span data-stu-id="edb26-127">If the shared state requires persistence, consider storing the shared state in a database.</span></span>

## <a name="required-configuration"></a><span data-ttu-id="edb26-128">必要な構成</span><span class="sxs-lookup"><span data-stu-id="edb26-128">Required configuration</span></span>

<span data-ttu-id="edb26-129">Web ファームに展開されるアプリに対して、データの保護とキャッシュを構成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="edb26-129">Data Protection and Caching require configuration for apps deployed to a web farm.</span></span>

### <a name="data-protection"></a><span data-ttu-id="edb26-130">データの保護</span><span class="sxs-lookup"><span data-stu-id="edb26-130">Data Protection</span></span>

<span data-ttu-id="edb26-131">アプリでは、データを保護するために [ASP.NET Core データ保護システム](xref:security/data-protection/introduction)が使用されます。</span><span class="sxs-lookup"><span data-stu-id="edb26-131">The [ASP.NET Core Data Protection system](xref:security/data-protection/introduction) is used by apps to protect data.</span></span> <span data-ttu-id="edb26-132">データ保護では、"*キー リング*" に格納されている一連の暗号化キーが利用されます。</span><span class="sxs-lookup"><span data-stu-id="edb26-132">Data Protection relies upon a set of cryptographic keys stored in a *key ring*.</span></span> <span data-ttu-id="edb26-133">データ保護システムを初期化すると、キー リングをローカルに格納する[既定の設定](xref:security/data-protection/configuration/default-settings)が適用されます。</span><span class="sxs-lookup"><span data-stu-id="edb26-133">When the Data Protection system is initialized, it applies [default settings](xref:security/data-protection/configuration/default-settings) that store the key ring locally.</span></span> <span data-ttu-id="edb26-134">既定の構成では、Web ファームの各ノード上に一意のキー リングが格納されます。</span><span class="sxs-lookup"><span data-stu-id="edb26-134">Under the default configuration, a unique key ring is stored on each node of the web farm.</span></span> <span data-ttu-id="edb26-135">このため、Web ファームの各ノードは、他のノード上のアプリが暗号化したデータを暗号化解除することはできません。</span><span class="sxs-lookup"><span data-stu-id="edb26-135">Consequently, each web farm node can't decrypt data that's encrypted by an app on any other node.</span></span> <span data-ttu-id="edb26-136">既定の構成が Web ファームでのアプリのホスト全般に対して適切であるわけではありません。</span><span class="sxs-lookup"><span data-stu-id="edb26-136">The default configuration isn't generally appropriate for hosting apps in a web farm.</span></span> <span data-ttu-id="edb26-137">共有キー リングを実装する代わりに、ユーザー要求を常に同じノードにルーティングすることもできます。</span><span class="sxs-lookup"><span data-stu-id="edb26-137">An alternative to implementing a shared key ring is to always route user requests to the same node.</span></span> <span data-ttu-id="edb26-138">Web ファームの展開に向けたデータ保護システムの構成について詳しくは、<xref:security/data-protection/configuration/overview> をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="edb26-138">For more information on Data Protection system configuration for web farm deployments, see <xref:security/data-protection/configuration/overview>.</span></span>

### <a name="caching"></a><span data-ttu-id="edb26-139">キャッシュ</span><span class="sxs-lookup"><span data-stu-id="edb26-139">Caching</span></span>

<span data-ttu-id="edb26-140">Web ファーム環境におけるキャッシュのメカニズムでは、Web ファームのノード間でキャッシュされる項目を共有する必要があります。</span><span class="sxs-lookup"><span data-stu-id="edb26-140">In a web farm environment, the caching mechanism must share cached items across the web farm's nodes.</span></span> <span data-ttu-id="edb26-141">キャッシュは、一般的な Redis Cache (SQL Server 共有データベース) を利用するか、またはキャッシュされる項目を Web ファーム間で共有するカスタム実装のキャッシュを利用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="edb26-141">Caching must either rely upon a common Redis cache, a shared SQL Server database, or a custom caching implementation that shares cached items across the web farm.</span></span> <span data-ttu-id="edb26-142">詳細については、「<xref:performance/caching/distributed>」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="edb26-142">For more information, see <xref:performance/caching/distributed>.</span></span>

## <a name="dependent-components"></a><span data-ttu-id="edb26-143">依存コンポーネント</span><span class="sxs-lookup"><span data-stu-id="edb26-143">Dependent components</span></span>

<span data-ttu-id="edb26-144">次のシナリオに追加構成は必要ありませんが、シナリオが依存するテクノロジには、Web ファーム用の構成が必要です。</span><span class="sxs-lookup"><span data-stu-id="edb26-144">The following scenarios don't require additional configuration, but they depend on technologies that require configuration for web farms.</span></span>

| <span data-ttu-id="edb26-145">シナリオ</span><span class="sxs-lookup"><span data-stu-id="edb26-145">Scenario</span></span> | <span data-ttu-id="edb26-146">依存先 &hellip;</span><span class="sxs-lookup"><span data-stu-id="edb26-146">Depends on &hellip;</span></span> |
| -------- | ------------------- |
| <span data-ttu-id="edb26-147">認証</span><span class="sxs-lookup"><span data-stu-id="edb26-147">Authentication</span></span> | <span data-ttu-id="edb26-148">データ保護 (<xref:security/data-protection/configuration/overview> を参照)。</span><span class="sxs-lookup"><span data-stu-id="edb26-148">Data Protection (see <xref:security/data-protection/configuration/overview>).</span></span><br><br><span data-ttu-id="edb26-149">詳細については、次のトピックを参照してください。 <xref:security/authentication/cookie> および <xref:security/cookie-sharing></span><span class="sxs-lookup"><span data-stu-id="edb26-149">For more information, see <xref:security/authentication/cookie> and <xref:security/cookie-sharing>.</span></span> |
| Identity | <span data-ttu-id="edb26-150">認証とデータベースの構成。</span><span class="sxs-lookup"><span data-stu-id="edb26-150">Authentication and database configuration.</span></span><br><br><span data-ttu-id="edb26-151">詳細については、「<xref:security/authentication/identity>」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="edb26-151">For more information, see <xref:security/authentication/identity>.</span></span> |
| <span data-ttu-id="edb26-152">セッション</span><span class="sxs-lookup"><span data-stu-id="edb26-152">Session</span></span> | <span data-ttu-id="edb26-153">データ保護 (暗号化された cookie) (<xref:security/data-protection/configuration/overview> を参照) とキャッシュ (<xref:performance/caching/distributed> を参照)。</span><span class="sxs-lookup"><span data-stu-id="edb26-153">Data Protection (encrypted cookies) (see <xref:security/data-protection/configuration/overview>) and Caching (see <xref:performance/caching/distributed>).</span></span><br><br><span data-ttu-id="edb26-154">詳細については、[セッションと状態の管理に関するページの「セッション状態」](xref:fundamentals/app-state#session-state)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="edb26-154">For more information, see [Session and state management: Session state](xref:fundamentals/app-state#session-state).</span></span> |
| <span data-ttu-id="edb26-155">TempData</span><span class="sxs-lookup"><span data-stu-id="edb26-155">TempData</span></span> | <span data-ttu-id="edb26-156">データ保護 (暗号化された cookie) (<xref:security/data-protection/configuration/overview> を参照) またはセッション ([セッションと状態の管理に関するページの「セッション状態」](xref:fundamentals/app-state#session-state)を参照)。</span><span class="sxs-lookup"><span data-stu-id="edb26-156">Data Protection (encrypted cookies) (see <xref:security/data-protection/configuration/overview>) or Session (see [Session and state management: Session state](xref:fundamentals/app-state#session-state)).</span></span><br><br><span data-ttu-id="edb26-157">詳細については、[セッションと状態の管理に関するページの「TempData」](xref:fundamentals/app-state#tempdata)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="edb26-157">For more information, see [Session and state management: TempData](xref:fundamentals/app-state#tempdata).</span></span> |
| <span data-ttu-id="edb26-158">偽造防止</span><span class="sxs-lookup"><span data-stu-id="edb26-158">Anti-forgery</span></span> | <span data-ttu-id="edb26-159">データ保護 (<xref:security/data-protection/configuration/overview> を参照)。</span><span class="sxs-lookup"><span data-stu-id="edb26-159">Data Protection (see <xref:security/data-protection/configuration/overview>).</span></span><br><br><span data-ttu-id="edb26-160">詳細については、「<xref:security/anti-request-forgery>」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="edb26-160">For more information, see <xref:security/anti-request-forgery>.</span></span> |

## <a name="troubleshoot"></a><span data-ttu-id="edb26-161">トラブルシューティング</span><span class="sxs-lookup"><span data-stu-id="edb26-161">Troubleshoot</span></span>

### <a name="data-protection-and-caching"></a><span data-ttu-id="edb26-162">データ保護とキャッシュ</span><span class="sxs-lookup"><span data-stu-id="edb26-162">Data Protection and caching</span></span>

<span data-ttu-id="edb26-163">データ保護またはキャッシュが Web ファーム環境用に構成されていない場合、要求の処理中に断続的にエラーが発生します。</span><span class="sxs-lookup"><span data-stu-id="edb26-163">When Data Protection or caching isn't configured for a web farm environment, intermittent errors occur when requests are processed.</span></span> <span data-ttu-id="edb26-164">このエラーは、ノード間で同じリソースが共有されておらず、ユーザー要求が同じノードにルーティングされない場合があるために発生します。</span><span class="sxs-lookup"><span data-stu-id="edb26-164">This occurs because nodes don't share the same resources and user requests aren't always routed back to the same node.</span></span>

<span data-ttu-id="edb26-165">ユーザーが cookie 認証を使用してアプリにサインインする場合を考えてみます。</span><span class="sxs-lookup"><span data-stu-id="edb26-165">Consider a user who signs into the app using cookie authentication.</span></span> <span data-ttu-id="edb26-166">このユーザーは、1 つの Web ファームのノード上にあるアプリにサインインします。</span><span class="sxs-lookup"><span data-stu-id="edb26-166">The user signs into the app on one web farm node.</span></span> <span data-ttu-id="edb26-167">ユーザーの次の要求が、ユーザーがサインインしたノードと同じノードに届いた場合、アプリは認証 cookie の暗号化を解除して、アプリのリソースへのアクセスを許可することができます。</span><span class="sxs-lookup"><span data-stu-id="edb26-167">If their next request arrives at the same node where they signed in, the app is able to decrypt the authentication cookie and allows access to the app's resource.</span></span> <span data-ttu-id="edb26-168">ユーザーの次の要求が異なるノードに届いた場合、アプリはユーザーがサインインしたノードの認証 cookie の暗号化を解除できず、要求されたリソースに対する認証は失敗します。</span><span class="sxs-lookup"><span data-stu-id="edb26-168">If their next request arrives at a different node, the app can't decrypt the authentication cookie from the node where the user signed in, and authorization for the requested resource fails.</span></span>

<span data-ttu-id="edb26-169">次の現象のいずれかが **断続的に** 発生するときは、多くの場合、データ保護またはキャッシュが Web ファーム環境に向けて適切に構成されていないことが問題の原因です。</span><span class="sxs-lookup"><span data-stu-id="edb26-169">When any of the following symptoms occur **intermittently**, the problem is usually traced to improper Data Protection or caching configuration for a web farm environment:</span></span>

* <span data-ttu-id="edb26-170">認証の中断:認証 cookie が正しく構成されていない、または暗号化解除できない。</span><span class="sxs-lookup"><span data-stu-id="edb26-170">Authentication breaks: The authentication cookie is misconfigured or can't be decrypted.</span></span> <span data-ttu-id="edb26-171">OAuth (Facebook、Microsoft、Twitter) ログインまたは OpenIdConnect ログインが「関連付けできませんでした」というエラーで失敗する。</span><span class="sxs-lookup"><span data-stu-id="edb26-171">OAuth (Facebook, Microsoft, Twitter) or OpenIdConnect logins fail with the error "Correlation failed."</span></span>
* <span data-ttu-id="edb26-172">承認の中断: Identity が失われる。</span><span class="sxs-lookup"><span data-stu-id="edb26-172">Authorization breaks: Identity is lost.</span></span>
* <span data-ttu-id="edb26-173">セッション状態でデータが失われる。</span><span class="sxs-lookup"><span data-stu-id="edb26-173">Session state loses data.</span></span>
* <span data-ttu-id="edb26-174">キャッシュされた項目が消える。</span><span class="sxs-lookup"><span data-stu-id="edb26-174">Cached items disappear.</span></span>
* <span data-ttu-id="edb26-175">TempData が失敗する。</span><span class="sxs-lookup"><span data-stu-id="edb26-175">TempData fails.</span></span>
* <span data-ttu-id="edb26-176">POST の失敗:偽造防止チェックが失敗する。</span><span class="sxs-lookup"><span data-stu-id="edb26-176">POSTs fail: The anti-forgery check fails.</span></span>

<span data-ttu-id="edb26-177">Web ファームの展開に向けたデータ保護の構成について詳しくは、<xref:security/data-protection/configuration/overview> をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="edb26-177">For more information on Data Protection configuration for web farm deployments, see <xref:security/data-protection/configuration/overview>.</span></span> <span data-ttu-id="edb26-178">Web ファームの展開に向けたキャッシュの構成について詳しくは、「<xref:performance/caching/distributed>」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="edb26-178">For more information on caching configuration for web farm deployments, see <xref:performance/caching/distributed>.</span></span>

## <a name="obtain-data-from-apps"></a><span data-ttu-id="edb26-179">アプリからデータを取得する</span><span class="sxs-lookup"><span data-stu-id="edb26-179">Obtain data from apps</span></span>

<span data-ttu-id="edb26-180">Web ファーム アプリが要求に応答できる場合は、ターミナル インライン ミドルウェアを使用して、要求、接続、その他のデータをアプリから取得します。</span><span class="sxs-lookup"><span data-stu-id="edb26-180">If the web farm apps are capable of responding to requests, obtain request, connection, and additional data from the apps using terminal inline middleware.</span></span> <span data-ttu-id="edb26-181">詳細およびサンプル コードについては、「<xref:test/troubleshoot#obtain-data-from-an-app>」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="edb26-181">For more information and sample code, see <xref:test/troubleshoot#obtain-data-from-an-app>.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="edb26-182">その他の技術情報</span><span class="sxs-lookup"><span data-stu-id="edb26-182">Additional resources</span></span>

* <span data-ttu-id="edb26-183">[Windows でのカスタムのスクリプト拡張機能](/azure/virtual-machines/extensions/custom-script-windows):Azure 仮想マシンにスクリプトをダウンロードして実行します。これは、デプロイ後の構成とソフトウェアのインストールに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="edb26-183">[Custom Script Extension for Windows](/azure/virtual-machines/extensions/custom-script-windows): Downloads and executes scripts on Azure virtual machines, which is useful for post-deployment configuration and software installation.</span></span>
* <xref:host-and-deploy/proxy-load-balancer>
 